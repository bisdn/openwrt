// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/*
 * Copyright (C) 2019 Marvell International Ltd.
 *
 * Device tree for the HK-5130 board which referred to cn9130-db.dtsi.
 */

#include "cn9130.dtsi"

#include <dt-bindings/gpio/gpio.h>

/ {
	model = "HK-5130 Series";
	compatible = "hawkeye,hk-5130", "marvell,cn9131", "marvell,cn9130",
			"marvell,armada-ap807-quad", "marvell,armada-ap807";

	chosen {
		stdout-path = "serial0:115200n8";
	};

	aliases {
		serial0 = &uart0;
		serial1 = &cp0_uart2;
		gpio1 = &cp0_gpio1;
		gpio2 = &cp0_gpio2;
		gpio3 = &cp1_gpio1;
		gpio4 = &cp1_gpio2;
		i2c0 = &cp0_mss_i2c;
		i2c1 = &cp0_i2c1;
		i2c2 = &cp1_mss_i2c;
		i2c3 = &cp1_i2c0;
		ethernet0 = &cp0_eth1;
		ethernet1 = &cp0_eth2;
		ethernet2 = &cp1_eth1;
		ethernet3 = &cp1_eth2;
		ethernet4 = &cp0_eth0;
		ethernet5 = &cp1_eth0;
		spi0 = &cp0_spi0;
		spi1 = &cp1_spi1;
	};

	memory@0 {
		device_type = "memory";
		reg = <0x0 0x0 0x0 0x80000000>;
	};

	cp0_reg_usb3_vbus0: cp0_usb3_vbus@0 {
		compatible = "regulator-fixed";
		regulator-name = "cp0-xhci0-vbus";
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;
		enable-active-high;
		gpio = <&cp0_gpio2 12 0>;
	};

	cp0_usb3_0_phy0: cp0_usb3_phy@0 {
		compatible = "usb-nop-xceiv";
		vcc-supply = <&cp0_reg_usb3_vbus0>;
	};

	cp0_reg_usb3_vbus1: cp0_usb3_vbus@1 {
		compatible = "regulator-fixed";
		regulator-name = "cp0-xhci1-vbus";
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;
		enable-active-high;
	};

	cp0_usb3_0_phy1: cp0_usb3_phy@1 {
		compatible = "usb-nop-xceiv";
		vcc-supply = <&cp0_reg_usb3_vbus1>;
	};

	cp0_sfp_eth0: cp0-sfp-eth0 {
		compatible = "sff,sfp";
		i2c-bus = <&cp0_mss_i2c>;
		mod-def0-gpio = <&cp1_gpio1 31 GPIO_ACTIVE_LOW>;
		tx-disable-gpio = <&expander0 9 GPIO_ACTIVE_HIGH>;
		tx-fault-gpio = <&expander0 8 GPIO_ACTIVE_HIGH>;
		pinctrl-names = "default";
		pinctrl-0 = <&cp1_sfp0_pins>;
		maximum-power-milliwatt = <2000>;
		status = "okay";
	};

	cp1_reg_usb3_vbus0: cp1_usb3_vbus@0 {
		compatible = "regulator-fixed";
		regulator-name = "cp1-xhci0-vbus";
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;
		enable-active-high;
	};

	cp1_usb3_0_phy0: cp1_usb3_phy@0 {
		compatible = "usb-nop-xceiv";
		vcc-supply = <&cp1_reg_usb3_vbus0>;
	};

	cp1_reg_usb3_vbus1: cp1_usb3_vbus@1 {
		compatible = "regulator-fixed";
		regulator-name = "cp1-xhci1-vbus";
		regulator-min-microvolt = <5000000>;
		regulator-max-microvolt = <5000000>;
		enable-active-high;
	};

	cp1_usb3_0_phy1: cp1_usb3_phy@1 {
		compatible = "usb-nop-xceiv";
		vcc-supply = <&cp1_reg_usb3_vbus1>;
	};

	cp1_sfp_eth0: cp1-sfp-eth0 {
		compatible = "sff,sfp";
		i2c-bus = <&cp1_i2c0>;
		mod-def0-gpio = <&cp1_gpio2 0 GPIO_ACTIVE_LOW>;
		tx-disable-gpio = <&expander0 11 GPIO_ACTIVE_HIGH>;
		tx-fault-gpio = <&expander0 10 GPIO_ACTIVE_HIGH>;
		pinctrl-names = "default";
		pinctrl-0 = <&cp1_sfp1_pins>;
		maximum-power-milliwatt = <2000>;
		status = "okay";
	};

	irq-buttons {
		compatible = "hawkeye,irq-buttons";
		btn1 {
			interrupt-parent = <&cp0_gpio2>;
			interrupts = <23 IRQ_TYPE_EDGE_RISING>;
		};
		btn2 {
			interrupt-parent = <&cp0_gpio2>;
			interrupts = <22 IRQ_TYPE_EDGE_RISING>;
		};
	};

	gpio-poweroff {
		compatible = "gpio-poweroff";
		gpios = <&expander0 15 1>;
		force;
	};

	gpio-leds {
		compatible = "gpio-leds";
		stat-green {
			gpios = <&cp0_gpio1 29 GPIO_ACTIVE_LOW>;
			default-state = "on";
		};
		stat-red {
			gpios = <&cp0_gpio1 30 GPIO_ACTIVE_LOW>;
			default-state = "off";
		};
	};
};

&uart0 {
	status = "okay";
};

/* on-board eMMC */
&ap_sdhci0 {
	pinctrl-names = "default";
	bus-width = <8>;
	mmc-ddr-1_8v;
	mmc-hs400-1_8v;
	status = "okay";
};

&cp0_uart2 {
	status = "okay";
};

&cp0_crypto {
	status = "okay";
};

&cp0_ethernet {
	status = "okay";
};

&cp0_eth0 {
	status = "okay";
	managed = "in-band-status";
	phy-mode = "10gbase-kr";
	phys = <&cp0_comphy4 0>;
	sfp = <&cp0_sfp_eth0>;
};

&cp0_eth1 {
	status = "okay";
	managed = "in-band-status";
	phy = <&cp0_phy0>;
	phy-mode = "sgmii";
	phys = <&cp0_comphy0 1>;
};

&cp0_eth2 {
	status = "okay";
	managed = "in-band-status";
	phy = <&cp0_phy1>;
	phy-mode = "sgmii";
	phys = <&cp0_comphy1 2>;
};

&cp0_gpio1 {
	status = "okay";
};

&cp0_gpio2 {
	status = "okay";
};

&cp0_mss_i2c {
	pinctrl-names = "default";
	pinctrl-0 = <&cp0_mss_i2c_pins>;
	status = "okay";
	clock-frequency = <100000>;

	expander0: pca953x@20 {
		compatible = "nxp,pca9555";
		gpio-controller;
		#gpio-cells = <2>;
		reg = <0x20>;
		status = "okay";
	};

};

&cp0_i2c1 {
	pinctrl-names = "default";
	pinctrl-0 = <&cp0_i2c1_pins>;
	status = "okay";
	clock-frequency = <100000>;

	temp@2f {
		compatible = "hawkeye,max6639";
		reg = <0x2f>;
		skip-init;
	};
};

&cp0_mdio {
	status = "okay";

	cp0_phy0: ethernet-phy@2 {
		reg = <2>;
	};

	cp0_phy1: ethernet-phy@1 {
		reg = <1>;
	};
};


&cp0_spi0 {
	status = "okay";
	pinctrl-names = "default";
	pinctrl-0 = <&cp0_spi0_pins>;

	spi-flash@0 {
		#address-cells = <0x1>;
		#size-cells = <0x1>;
		compatible = "jedec,spi-nor";
		reg = <0x0>;
		/* On-board MUX does not allow higher frequencies */
		spi-max-frequency = <40000000>;

	};
};

&cp0_pinctrl {
	compatible = "marvell,cp115-standalone-pinctrl";

	cp0_mss_i2c_pins: cp0-i2c-pins-0 {
		marvell,pins = "mpp0", "mpp1";
		marvell,function = "mss_i2c";
	};
	cp0_i2c1_pins: cp0-i2c-pins-1 {
		marvell,pins = "mpp2", "mpp3";
		marvell,function = "i2c1";
	};
	cp0_spi0_pins: cp0-spi-pins-0 {
		marvell,pins = "mpp56", "mpp57", "mpp58", "mpp59";
		marvell,function = "spi0";
	};
};

&cp0_utmi {
	status = "okay";
};

&cp0_usb3_0 {
	status = "okay";
	usb-phy = <&cp0_usb3_0_phy0>;
	phys = <&cp0_comphy2 0>, <&cp0_utmi0>;
	phy-names = "usb3", "utmi";
	dr_mode = "host";
};

&cp0_usb3_1 {
	status = "okay";
	usb-phy = <&cp0_usb3_0_phy1>;
	phys =  <&cp0_utmi1>;
	phy-names = "utmi";
	dr_mode = "host";
};


/*
 * Instantiate the first slave CP115 on MCi1
 */

#define CP11X_NAME              cp1
#define CP11X_NUM               1
#define CP11X_BASE              f6000000
#define CP11X_PCIEx_MEM_BASE(iface) (0xe5000000 + (iface * 0x1000000))
#define CP11X_PCIEx_MEM_SIZE(iface) 0xf00000
#define CP11X_PCIE0_BASE        f6600000
#define CP11X_PCIE1_BASE        f6620000
#define CP11X_PCIE2_BASE        f6640000

#include "armada-cp115.dtsi"

#undef CP11X_NAME
#undef CP11X_NUM
#undef CP11X_BASE
#undef CP11X_PCIEx_MEM_BASE
#undef CP11X_PCIEx_MEM_SIZE
#undef CP11X_PCIE0_BASE
#undef CP11X_PCIE1_BASE
#undef CP11X_PCIE2_BASE

&cp1_pinctrl {
	compatible = "marvell,cp115-standalone-pinctrl";

	cp1_mss_i2c_pins: cp1-i2c-pins-0 {
		marvell,pins = "mpp29", "mpp30";
		marvell,function = "mss_i2c";
	};
	cp1_i2c0_pins: cp1-i2c-pins-1 {
		marvell,pins = "mpp37", "mpp38";
		marvell,function = "i2c0";
	};
	cp1_spi1_pins: cp1-spi-pins-0 {
		marvell,pins = "mpp47", "mpp48", "mpp49", "mpp50";
		marvell,function = "spi1";
	};
	cp1_sdhci_cd_pins: cp1-sdhci-cd-pins-0 {
		marvell,pins = "mpp55";
		marvell,function = "sdio";
	};
	cp1_sdhci_pins: cp1-sdhci-pins-0 {
		marvell,pins = "mpp56", "mpp57", "mpp58", "mpp59",
				"mpp60", "mpp61";
		marvell,function = "sdio";
	};
	cp1_sfp0_pins: cp1-sfp-pins-0 {
		marvell,pins = "mpp31";
		marvell,function = "gpio";
	};
	cp1_sfp1_pins: cp1-sfp-pins-1 {
		marvell,pins = "mpp32";
		marvell,function = "gpio";
	};
};

&cp1_mss_i2c {
	pinctrl-names = "default";
	pinctrl-0 = <&cp1_mss_i2c_pins>;
	status = "okay";
	clock-frequency = <100000>;
};

&cp1_i2c0 {
	pinctrl-names = "default";
	pinctrl-0 = <&cp1_i2c0_pins>;
	status = "okay";
	clock-frequency = <100000>;
};

&cp1_spi1 {
	status = "okay";
	pinctrl-names = "default";
	pinctrl-0 = <&cp1_spi1_pins>;

	tpm: npct75x@0 {
		compatible = "tcg,tpm_tis-spi";
		spi-max-frequency = <50000000>;
		reg = <0>;
	};
};

&cp1_crypto {
	/*
	 * The cryptographic engine found on the cp110
	 * master is enabled by default at the SoC
	 * level. Because it is not possible as of now
	 * to enable two cryptographic engines in
	 * parallel, disable this one by default.
	 */
	status = "disabled";
};

&cp1_gpio1 {
	status = "okay";
};

&cp1_gpio2 {
	status = "okay";
};

&cp1_sdhci0 {
	pinctrl-names = "default";
	pinctrl-0 = <&cp1_sdhci_pins &cp1_sdhci_cd_pins>;
	bus-width = <4>;
	cd-gpios = <&cp1_gpio2 23 GPIO_ACTIVE_LOW>;
	no-1-8-v;
	status = "okay";
};

&cp1_ethernet {
	status = "okay";
};

&cp1_eth0 {
	status = "okay";
	managed = "in-band-status";
	phy-mode = "10gbase-kr";
	phys = <&cp1_comphy2 0>;
	sfp = <&cp1_sfp_eth0>;
};

&cp1_eth1 {
	status = "okay";
	managed = "in-band-status";
	phy = <&cp1_phy0>;
	phy-mode = "sgmii";
	phys = <&cp1_comphy0 1>;
};

&cp1_eth2 {
	status = "okay";
	managed = "in-band-status";
	phy = <&cp1_phy1>;
	phy-mode = "sgmii";
	phys = <&cp1_comphy1 2>;
};

&cp1_mdio {
	status = "okay";

	cp1_phy0: ethernet-phy@4 {
		reg = <4>;
	};

	cp1_phy1: ethernet-phy@3 {
		reg = <3>;
	};
};

&cp1_utmi {
	status = "okay";
};

&cp1_usb3_0 {
	status = "okay";
	usb-phy = <&cp1_usb3_0_phy0>;
	phys = <&cp1_utmi0>;
	phy-names = "utmi";
	dr_mode = "host";
};

&cp1_usb3_1 {
	status = "okay";
	usb-phy = <&cp1_usb3_0_phy1>;
	phys =  <&cp1_comphy3 1>, <&cp1_utmi1>;
	phy-names = "usb3", "utmi";
	dr_mode = "host";
};

&cp1_pcie1 {
	num-lanes = <1>;
	phys = <&cp1_comphy4 1>;
	status = "okay";
};

&cp1_pcie2 {
	num-lanes = <1>;
	phys = <&cp1_comphy5 2>;
	status = "okay";
};
